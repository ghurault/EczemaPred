<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Binomial random walk model • EczemaPred</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Binomial random walk model">
<meta property="og:description" content="EczemaPred">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">EczemaPred</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/BinRW.html">Binomial random walk model</a>
    </li>
    <li>
      <a href="../articles/ContinuousModels.html">Continuous models</a>
    </li>
    <li>
      <a href="../articles/MC.html">Markov Chain model</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="BinRW_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Binomial random walk model</h1>
            
      
      
      <div class="hidden name"><code>BinRW.Rmd</code></div>

    </div>

    
    
<p>In this example, I will show how to use the Binomial random walk model (BinRW), notably how to generate data from the prior predictive distribution, how to fit the model to data and how to analyse the results.</p>
<p>This vignette could also be used as a demonstration for the other discrete longitudinals models, i.e. the Binomial Markov Chain (BinMC) and the ordered logistic random walk model (OrderedRW), which have a similar architecture.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">EczemaPred</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/">cowplot</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstan">rstan</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="co"># Parallel computing</span>

<span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.arg.html">match.arg</a></span><span class="op">(</span><span class="va">params</span><span class="op">$</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"BinRW"</span>, <span class="st">"BinMC"</span>, <span class="st">"OrderedRW"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2021</span><span class="op">)</span> <span class="co"># For reproducibility</span>

<span class="va">N_patient</span> <span class="op">&lt;-</span> <span class="fl">10</span>
<span class="va">t_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="va">N_patient</span>, <span class="fl">50</span><span class="op">)</span>

<span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/list_parameters.html">list_parameters</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>
<span class="va">pars_of_interest</span> <span class="op">&lt;-</span> <span class="va">pars</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Population"</span>, <span class="st">"Patient"</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<div id="prior-predictive-distribution" class="section level2">
<h2 class="hasAnchor">
<a href="#prior-predictive-distribution" class="anchor"></a>Prior predictive distribution</h2>
<p>First, we sample from the prior predictive distribution to inspect the prior and generate fake data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_prior_discrete.html">sample_prior_discrete</a></span><span class="op">(</span>N_patient <span class="op">=</span> <span class="va">N_patient</span>,
                              t_max <span class="op">=</span> <span class="va">t_max</span>,
                              max_score <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">max_score</span>,
                              model <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">model</span>,
                              chains <span class="op">=</span> <span class="fl">1</span>,
                              refresh <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://mc-stan.org/rstan/reference/check_hmc_diagnostics.html">check_hmc_diagnostics</a></span><span class="op">(</span><span class="va">fit0</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Divergences:</span>
<span class="co">#&gt; 0 of 1000 iterations ended with a divergence.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Tree depth:</span>
<span class="co">#&gt; 0 of 1000 iterations saturated the maximum tree depth of 10.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Energy:</span>
<span class="co">#&gt; E-BFMI indicated no pathological behavior.</span>
<span class="co"># pairs(fit0, pars = pars$Population)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit0</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">pars</span><span class="op">$</span><span class="va">Population</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">pars</span><span class="op">$</span><span class="va">Patient</span>, <span class="st">"[1]"</span><span class="op">)</span><span class="op">)</span>, plotfun <span class="op">=</span> <span class="st">"hist"</span><span class="op">)</span>
<span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></code></pre></div>
<p><img src="BinRW_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
</div>
<div id="generating-fake-data" class="section level2">
<h2 class="hasAnchor">
<a href="#generating-fake-data" class="anchor"></a>Generating fake data</h2>
<p>We generate fake data by choosing a draw from one the prior predictive distribution.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p_mis</span> <span class="op">&lt;-</span> <span class="fl">.1</span>
<span class="va">p_obs_obs</span> <span class="op">&lt;-</span> <span class="fl">.9</span>
<span class="va">horizon</span> <span class="op">&lt;-</span> <span class="fl">5</span>

<span class="co"># Take one draw (different draws corresponds to different a priori pattern in the data)</span>
<span class="va">draw</span> <span class="op">&lt;-</span> <span class="fl">4</span>

<span class="va">true_param</span> <span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html">extract</a></span><span class="op">(</span><span class="va">fit0</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">pars</span><span class="op">$</span><span class="va">Population</span>, <span class="va">pars</span><span class="op">$</span><span class="va">Patient</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">HuraultMisc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/HuraultMisc/man/extract_draws.html">extract_draws</a></span><span class="op">(</span><span class="va">draw</span><span class="op">)</span>

<span class="va">yrep</span> <span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html">extract</a></span><span class="op">(</span><span class="va">fit0</span>, pars <span class="op">=</span> <span class="st">"y_rep"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>

<span class="va">fd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_index.html">get_index2</a></span><span class="op">(</span><span class="va">t_max</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Score <span class="op">=</span> <span class="va">yrep</span><span class="op">[</span><span class="va">draw</span>, <span class="op">]</span><span class="op">)</span></code></pre></div>
<p>We artificially produce missing values to make the data more representative to what we observe in real life. Here, we generate missingness using a two-state Markov Chain.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N_patient</span>,
             <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span>
               <span class="va">sub_fd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">fd</span>, <span class="va">Patient</span> <span class="op">==</span> <span class="va">i</span><span class="op">)</span>
               <span class="va">id_mis</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_missing.html">generate_missing</a></span><span class="op">(</span><span class="va">t_max</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">horizon</span>, type <span class="op">=</span> <span class="st">"markovchain"</span>, p_mis <span class="op">=</span> <span class="va">p_mis</span>, p_obs_obs <span class="op">=</span> <span class="va">p_obs_obs</span><span class="op">)</span>
               <span class="va">id_mis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">id_mis</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="va">horizon</span><span class="op">)</span><span class="op">)</span> <span class="co"># don't generate missing values for prediction horizon</span>
               <span class="va">sub_fd</span><span class="op">[</span><span class="va">id_mis</span>, <span class="st">"Score"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
               <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">sub_fd</span><span class="op">)</span>
             <span class="op">}</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>We inspect the time-series of a few patients.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N_patient</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">N_patient</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
       <span class="kw">function</span><span class="op">(</span><span class="va">pid</span><span class="op">)</span> <span class="op">{</span>
         <span class="va">fd</span> <span class="op">%&gt;%</span>
           <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Patient</span> <span class="op">==</span> <span class="va">pid</span><span class="op">)</span> <span class="op">%&gt;%</span>
           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Time</span>, y <span class="op">=</span> <span class="va">Score</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">params</span><span class="op">$</span><span class="va">max_score</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Patient "</span>, <span class="va">pid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>
       <span class="op">}</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html">plot_grid</a></span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">.</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p><img src="BinRW_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
</div>
<div id="fitting-data-to-the-model" class="section level2">
<h2 class="hasAnchor">
<a href="#fitting-data-to-the-model" class="anchor"></a>Fitting data to the model</h2>
<p>Now, we perform fake data check, i.e. fitting the model to the fake data extracted from the prior predictive distribution to see if we can recover the true parameters.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">train</span> <span class="op">&lt;-</span> <span class="va">fd</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Patient</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Time</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">Time</span><span class="op">)</span> <span class="op">-</span> <span class="va">horizon</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">test</span> <span class="op">&lt;-</span> <span class="va">fd</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Patient</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Time</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">Time</span><span class="op">)</span> <span class="op">-</span> <span class="va">horizon</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Horizon <span class="op">=</span> <span class="va">Time</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">Time</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_discrete.html">fit_discrete</a></span><span class="op">(</span>train <span class="op">=</span> <span class="va">train</span>,
                    test <span class="op">=</span> <span class="va">test</span>,
                    max_score <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">max_score</span>,
                    model <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">model</span>,
                    chains <span class="op">=</span> <span class="fl">1</span>, <span class="co"># only one chain for speed</span>
                    refresh <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<div id="diagnostics" class="section level3">
<h3 class="hasAnchor">
<a href="#diagnostics" class="anchor"></a>Diagnostics</h3>
<p>We look for evidence of an absence of convergences by inspecting divergences and trace plots.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://mc-stan.org/rstan/reference/check_hmc_diagnostics.html">check_hmc_diagnostics</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Divergences:</span>
<span class="co">#&gt; 0 of 1000 iterations ended with a divergence.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Tree depth:</span>
<span class="co">#&gt; 0 of 1000 iterations saturated the maximum tree depth of 10.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Energy:</span>
<span class="co">#&gt; E-BFMI indicated no pathological behavior.</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html">pairs</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="va">pars</span><span class="op">$</span><span class="va">Population</span><span class="op">)</span></code></pre></div>
<p><img src="BinRW_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="va">pars</span><span class="op">$</span><span class="va">Population</span>, plotfun <span class="op">=</span> <span class="st">"trace"</span><span class="op">)</span></code></pre></div>
<p><img src="BinRW_files/figure-html/unnamed-chunk-8-2.png" width="700"></p>
</div>
<div id="posterior-estimates" class="section level3">
<h3 class="hasAnchor">
<a href="#posterior-estimates" class="anchor"></a>Posterior estimates</h3>
<p>We visualise posterior estimates and compare them to their prior.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">par0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_parameters.html">extract_parameters</a></span><span class="op">(</span><span class="va">fit0</span>, pars <span class="op">=</span> <span class="va">pars_of_interest</span><span class="op">)</span>
<span class="va">par</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_parameters.html">extract_parameters</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="va">pars_of_interest</span><span class="op">)</span>
<span class="fu">HuraultMisc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/HuraultMisc/man/prior_posterior.html">plot_prior_posterior</a></span><span class="op">(</span><span class="va">par0</span>, <span class="va">par</span>, pars <span class="op">=</span> <span class="va">pars</span><span class="op">$</span><span class="va">Population</span><span class="op">)</span></code></pre></div>
<p><img src="BinRW_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>We can also quantify the influence of the prior on the posterior estimates by computing the posterior shrinkage and Mahalanobis distance between the mean posterior and the prior. The posterior shrinkage roughly quantifies how much the model is learning, and is defined for a parameter <span class="math inline">\(\theta\)</span> as <span class="math inline">\(1 - \frac{\operatorname{Var}(\theta_\text{post})}{\operatorname{Var}(\theta_\text{prior}}\)</span>. The distance between the prior and posterior can be used to assess whether the prior is informative or not, where a distance greater than 2 or 3 could be interpreted as a posterior that is not “included” in the prior.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">HuraultMisc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/HuraultMisc/man/prior_posterior.html">plot_prior_influence</a></span><span class="op">(</span><span class="va">par0</span>, <span class="va">par</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">pars_of_interest</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="BinRW_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
</div>
<div id="can-we-recover-the-true-parameters" class="section level3">
<h3 class="hasAnchor">
<a href="#can-we-recover-the-true-parameters" class="anchor"></a>Can we recover the true parameters?</h3>
<p>We compare the posterior estimates to the true parameters to see if the algorithm worked as expected.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">par</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">true_param</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Variable"</span> <span class="op">=</span> <span class="st">"Parameter"</span>, <span class="st">"Index"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>True <span class="op">=</span> <span class="va">Value</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Variable</span>, group <span class="op">=</span> <span class="va">Index</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_pointrange</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">Mean</span>, ymin <span class="op">=</span> <span class="va">`5%`</span>, ymax <span class="op">=</span> <span class="va">`95%`</span>, colour <span class="op">=</span> <span class="st">"Posterior"</span><span class="op">)</span>,
                    position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">True</span>, colour <span class="op">=</span> <span class="st">"Truth"</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span>,
               position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Posterior"</span> <span class="op">=</span> <span class="st">"black"</span>, <span class="st">"Truth"</span> <span class="op">=</span> <span class="st">"#E69F00"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">""</span>, y <span class="op">=</span> <span class="st">"Estimate"</span>, colour <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span></code></pre></div>
<p><img src="BinRW_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<p>We can also quantify the “accuracy” of posterior estimates by computing the coverage probability of the parameters in the model, that is the proportion of parameters for which the x% credible interval includes the true value. For instance, we would expect that approximately 50% of the parameters have their 50% credible interval including the true value.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">HuraultMisc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/HuraultMisc/man/coverage.html">plot_coverage</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html">extract</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="va">true_param</span><span class="op">[[</span><span class="st">"Parameter"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,
                           <span class="va">true_param</span><span class="op">[[</span><span class="st">"Value"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p><img src="BinRW_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
</div>
<div id="posterior-predictive-trajectory" class="section level3">
<h3 class="hasAnchor">
<a href="#posterior-predictive-trajectory" class="anchor"></a>Posterior predictive trajectory</h3>
<p>We inspect the posterior predictive trajectory to detect any discrepancies between the data and model’s simulations.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">20</span> <span class="op">/</span> <span class="op">(</span><span class="va">params</span><span class="op">$</span><span class="va">max_score</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">pl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N_patient</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,
       <span class="kw">function</span><span class="op">(</span><span class="va">pid</span><span class="op">)</span> <span class="op">{</span>
         <span class="kw"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span><span class="op">(</span><span class="op">{</span>
           <span class="fu"><a href="../reference/plot_ppc.html">plot_ppc_traj_pmf</a></span><span class="op">(</span><span class="va">fit</span>, train <span class="op">=</span> <span class="va">train</span>, test <span class="op">=</span> <span class="va">test</span>, patient_id <span class="op">=</span> <span class="va">pid</span>, max_score <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">max_score</span>, max_scale <span class="op">=</span> <span class="va">ms</span><span class="op">)</span> <span class="op">+</span>
           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Patient "</span>, <span class="va">pid</span><span class="op">)</span><span class="op">)</span>
         <span class="op">}</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span><span class="cn">NULL</span><span class="op">}</span><span class="op">)</span>
       <span class="op">}</span><span class="op">)</span>
<span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html">plot_grid</a></span><span class="op">(</span>
  <span class="fu"><a href="https://wilkelab.org/cowplot/reference/get_legend.html">get_legend</a></span><span class="op">(</span><span class="va">pl</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span><span class="op">)</span>,
  <span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html">plot_grid</a></span><span class="op">(</span>plotlist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">pl</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="va">x</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span><span class="op">}</span><span class="op">)</span>,
            ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,
  ncol <span class="op">=</span> <span class="fl">1</span>, rel_heights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.1</span>, <span class="fl">.9</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p><img src="BinRW_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
</div>
<div id="performance" class="section level3">
<h3 class="hasAnchor">
<a href="#performance" class="anchor"></a>Performance</h3>
<p>Finally, we compute the lpd and RPS for each observation in the test set and plot the average metrics as a function of prediction horizon. We would expect a lower performance (decreased lpd, increased RPS) with increasing prediction horizon.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">test</span> <span class="op">&lt;-</span> <span class="va">test</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>lpd <span class="op">=</span> <span class="fu"><a href="../reference/extract_metric.html">extract_lpd</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>,
         RPS <span class="op">=</span> <span class="fu"><a href="../reference/extract_metric.html">extract_RPS</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span><span class="op">)</span>

<span class="va">test</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lpd"</span>, <span class="st">"RPS"</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"Metric"</span>, values_to <span class="op">=</span> <span class="st">"Value"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">Metric</span>, <span class="va">Horizon</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>Mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Value</span><span class="op">)</span>, SD <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">Value</span><span class="op">)</span>, SE <span class="op">=</span> <span class="va">SD</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Horizon</span>, y <span class="op">=</span> <span class="va">Mean</span>, ymin <span class="op">=</span> <span class="va">Mean</span> <span class="op">-</span> <span class="va">SE</span>, ymax <span class="op">=</span> <span class="va">Mean</span> <span class="op">+</span> <span class="va">SE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_pointrange</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">Metric</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></code></pre></div>
<p><img src="BinRW_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Guillem Hurault.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
